{% if query %}
<section aria-labelledby="results-heading">
    <figure class="mb-2" hidden> <!-- Unhide for debug -->
        <figcaption id="results-heading" class="font-semibold">Results for:</figcaption>
        <pre
            class="mt-2 p-3 bg-gray-50 rounded-md shadow-sm border border-gray-200  whitespace-pre-wrap">"{{ query | e }}"</pre>
    </figure>

    {% if results_for_query %}
    <ul class="space-y-3">
        {% for result in results_for_query %}
        <li class="p-3 bg-gray-50 rounded-md shadow-sm border border-gray-200">
            <button type="button" onclick="window.copyOriginalId('{{ result.payload.original_id | e }}', this)"
                title="Copy ID">ðŸ“‹
            </button>
            <a href="{{ base_url }}{{ result.payload.original_id | e }}" target="_blank"
                class="text-blue-600 hover:underline">{{ result.payload.original_id | e }}â†—</a>
            {{ result.payload.class_name | e }}
            {% if result.payload.id_level %}({{ result.payload.id_level | e }}){% endif %}
            <span class="text-gray-400">Score: {{ "%.0f"|format(result.score * 100) }}</span>
            <br><span class="text-gray-500">{{ result.payload.definition | e }}</span>
        </li>
        {% endfor %}
    </ul>
    <div class="mt-3 text-left text-gray-600">
        {% if total_request_time is not none %}
        <span>Total request time: {{ "%.2f"|format(total_request_time) }}s</span>
        {% endif %}
    </div>
    {% else %}
    <div>
        <p class="text-left text-gray-600">Not found</p>
    </div>
    {% endif %}
</section>

{% else %}
<section>
    <p class="text-left text-gray-600">Please enter a query</p>
</section>
{% endif %}

<script>
    if (typeof window.copyOriginalId !== 'function') {
        window.copyOriginalId = function (text, buttonElement) {
            // --- Tooltip Function ---
            function showTooltip(element, message) {
                const tooltip = document.createElement('span');
                tooltip.textContent = message;
                // Basic styling for the tooltip
                tooltip.style.position = 'absolute';
                tooltip.style.backgroundColor = 'black';
                tooltip.style.color = 'white';
                tooltip.style.padding = '4px 8px';
                tooltip.style.borderRadius = '4px';
                tooltip.style.fontSize = '0.75rem'; // text-xs
                tooltip.style.zIndex = '1000';     // Ensure it's on top
                tooltip.style.textAlign = 'center';

                // Append to body to avoid clipping issues and for correct initial dimension calculation
                document.body.appendChild(tooltip);

                const buttonRect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect(); // Get dimensions after appending and styling

                // Position above the button, centered, with scroll offset
                let top = buttonRect.top + window.scrollY - tooltipRect.height - 5; // 5px spacing
                let left = buttonRect.left + window.scrollX + (buttonRect.width / 2) - (tooltipRect.width / 2);

                // Adjust if tooltip goes off-screen (viewport relative checks)
                if (buttonRect.top - tooltipRect.height - 5 < 0) { // Not enough space above
                    top = buttonRect.bottom + window.scrollY + 5; // Position below
                }
                if (left - window.scrollX < 0) { // Off-screen left
                    left = window.scrollX;
                }
                if (left - window.scrollX + tooltipRect.width > window.innerWidth) { // Off-screen right
                    left = window.scrollX + window.innerWidth - tooltipRect.width;
                }

                tooltip.style.top = `${top}px`;
                tooltip.style.left = `${left}px`;

                buttonElement.disabled = true; // Disable button

                setTimeout(function () {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                    buttonElement.disabled = false; // Re-enable button
                }, 500); // Tooltip lasts for 0.5 seconds
            }
            // --- End Tooltip Function ---

            if (!navigator.clipboard) {
                // Fallback for older browsers or insecure contexts (e.g. http)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; // Prevent scrolling to bottom
                textArea.style.opacity = "0"; // Hide the textarea
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showTooltip(buttonElement, 'Copied!');
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    showTooltip(buttonElement, 'Copy failed');
                }
                document.body.removeChild(textArea);
                return;
            }

            navigator.clipboard.writeText(text).then(function () {
                showTooltip(buttonElement, 'Copied!');
            }).catch(function (err) {
                console.error('Async: Could not copy text: ', err);
                showTooltip(buttonElement, 'Copy failed');
            });
        }
    }
</script>